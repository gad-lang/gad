package main

import (
	"bytes"
	"fmt"
	"os"
	"os/exec"
	"strings"

	"github.com/gad-lang/gad/token"
)

const (
	builtinBinaryPrefix = "BuiltinBinaryOperator"
	tBinaryPrefix       = "TBinaryOperator"

	builtinSelfAssignPrefix = "BuiltinSelfAssignOperator"
	tSelfAssignPrefix       = "TSelfAssignOperator"
)

func main() {
	binaryOperators := listGroup(token.GroupBinaryOperatorBegin, token.GroupBinaryOperatorEnd)
	selfAssignOperators := listGroup(token.GroupSelfAssignOperatorBegin, token.NullichAssign)
	for i, op := range selfAssignOperators {
		selfAssignOperators[i] = token.Unassign(op)
	}

	var f strings.Builder
	f.WriteString("// Code generated by 'go generate'; DO NOT EDIT.\n")
	f.WriteString("package gad\n")
	f.WriteString("import \"github.com/gad-lang/gad/token\"\n")
	f.WriteString("var (\n")
	for _, o := range binaryOperators {
		fmt.Fprintf(&f, "%s%s = BinaryOperatorType(token.%[2]s) // %s\n", tBinaryPrefix, o.Name(), o.String())
	}
	f.WriteString("\n")
	for _, o := range selfAssignOperators {
		fmt.Fprintf(&f, "%s%s = SelfAssignOperatorType(token.%[2]s) // %s\n", tSelfAssignPrefix, o.Name(), o.String())
	}
	f.WriteString(")\n")
	f.WriteString("func init () {\n")

	f.WriteString("add := func(bt BuiltinType, t ObjectType) {\n" +
		"BuiltinObjects[bt] = t\n" +
		"BuiltinsMap[t.Name()] = bt\n" +
		"}\n")
	for _, o := range binaryOperators {
		fmt.Fprintf(&f, "add(%[1]s%[3]s, %[2]s%[3]s)\n", builtinBinaryPrefix, tBinaryPrefix, o.Name())
	}
	f.WriteString("\n")
	for _, o := range selfAssignOperators {
		fmt.Fprintf(&f, "add(%[1]s%[3]s, %[2]s%[3]s)\n", builtinSelfAssignPrefix, tSelfAssignPrefix, o.Name())
	}
	f.WriteString("}\n")

	outName := "builtin_operators.go"

	if err := os.WriteFile("builtin_operators.go", []byte(f.String()), 0666); err != nil {
		panic(err)
	}

	err := exec.Command("go", "fmt", outName).Run()
	if err != nil {
		panic(err)
	}

	builtins, err := os.ReadFile("builtins.go")
	if err != nil {
		panic(err)
	}

	builtins = appendBuiltins(builtins, builtinBinaryPrefix, binaryOperators)
	builtins = appendBuiltins(builtins, builtinSelfAssignPrefix, selfAssignOperators)

	if err := os.WriteFile("builtins.go", builtins, 0666); err != nil {
		panic(err)
	}

	if err := exec.Command("go", "fmt", "builtins.go").Run(); err != nil {
		panic(err)
	}
}

func listGroup(groupStart, groupEnd token.Token) (r []token.Token) {
	r = make([]token.Token, groupEnd-groupStart-1)
	for t := groupStart + 1; t < groupEnd; t++ {
		r[t-groupStart-1] = t
	}
	return
}

func appendBuiltins(data []byte, prefix string, tokens []token.Token) []byte {
	var (
		name      = "Group" + prefix + "s"
		startName = []byte(name + "Begin")
		endName   = []byte(name + "End")
		start     = bytes.Index(data, startName)
	)
	if start == -1 {
		panic("bad name " + name + "Begin_")
	}

	end := bytes.Index(data, endName)
	if end == -1 {
		panic("bad name " + name + "End_")
	}

	var buf bytes.Buffer
	buf.Write(bytes.TrimSpace(data[:start]))
	buf.WriteString("\n\n")
	buf.Write(startName)
	buf.WriteByte('\n')

	for _, t := range tokens {
		buf.WriteString(prefix)
		buf.WriteString(t.Name())
		buf.WriteByte('\n')
	}

	buf.Write(endName)
	buf.WriteString("\n\n")

	buf.Write(bytes.TrimSpace(data[end+len(endName):]))
	return buf.Bytes()
}
